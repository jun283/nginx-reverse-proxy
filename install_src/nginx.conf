user nginx;
pid logs/nginx.pid;
worker_processes auto; 

#error_log logs/error.log debug;
#error_log logs/error.log notice;
#error_log logs/error.log info;
#error_log logs/error.log warn;
error_log logs/error.log error;
#error_log logs/error.log crit;
#error_log logs/error.log alert;
#error_log logs/error.log emerg;

events {
    # determines how much clients will be served per worker
    # max clients = worker_connections * worker_processes
    # max clients is also limited by the number of socket connections available on the system (~64k)
    # The systemâ€™s core limitations can also be find through using:
    # ulimit -n
    worker_connections   65535;
    use epoll;
    multi_accept on;
}


# number of file descriptors used for nginx
# the limit for the maximum FDs on the server is usually set by the OS.
# if you don't set FD's then OS settings will be used which is by default 2000
worker_rlimit_nofile 100000;



http {
	include mime.types;
    include _c_default.conf;
    default_type  application/octet-stream;
    
    
    
    
	#log_format  graylog2_format  '$remote_addr - $remote_user [$time_local] "$request" $status $body_bytes_sent "$http_referer" "$http_user_agent" "$http_x_forwarded_for" <msec=$msec|connection=$connection|connection_requests=$connection_requests|millis=$request_time>';

	#BOF GeoIP
	geoip_country /usr/share/GeoIP/GeoIP.dat;
	#geoip_city /usr/share/GeoIP/GeoLiteCity.dat;
	fastcgi_param GEOIP_COUNTRY_CODE $geoip_country_code;
	fastcgi_param GEOIP_COUNTRY_CODE3 $geoip_country_code3;
	fastcgi_param GEOIP_COUNTRY_NAME $geoip_country_name;
	#EOF GeoIP
    
    

    keepalive_timeout 65;
    keepalive_requests 100000;
    sendfile         on;
    tcp_nopush       on;
    tcp_nodelay      on;


client_body_buffer_size    128k;
client_max_body_size       10m;
client_header_buffer_size    1k;
large_client_header_buffers  4 4k;
output_buffers   1 32k;
postpone_output  1460;

    client_header_timeout  3m;
    client_body_timeout    3m;
    send_timeout           3m;



open_file_cache max=200000 inactive=20s; 
open_file_cache_valid 30s; 
open_file_cache_min_uses 2;
open_file_cache_errors on;

    gzip on;
gzip_min_length 10240;
gzip_buffers     4 4k;
gzip_proxied expired no-cache no-store private auth;
gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/json application/xml;
gzip_disable msie6;

reset_timedout_connection on;


    
	#proxy_temp_path /usr/local/nginx/proxy_temp;

	###proxy_cache
	

	###upstream
    upstream toffs {
        server 52.77.60.19:80;
	#server  www.toffstech.com.cdnga.net;
    
    }
    
    server {
       listen 80 default;
        server_name _;
        add_header ACDN-Toffstech-Version "NGX";
        location /
		{
			expires -1;
			add_header Register "Domain not found";
			return 403 "403 Forbidden or No Permission to Access";
		}
    }

	###server
    server {
        listen 80;
        server_name ngx2.toffstech.com;

		#access_log syslog:server=52.76.157.46:12321 graylog2_format;
		#error_log syslog:server=52.76.157.46:12312;
        access_log syslog:server=52.76.157.46:12321;

		###test-cookie level 1 (test pass)
		testcookie off;
    	testcookie_name ToffsCDN;
    	testcookie_secret Toffsiueyriuyewryoyrowesjldbflweooiweyroweyowoe;
    	testcookie_session $remote_addr;
    	testcookie_arg attempt;
    	testcookie_max_attempts 3;
    	#testcookie_fallback /cookies.html?backurl=http://$host$request_uri;
    	testcookie_get_only on;

		###test-cookie level 2 (test pass)
		###testcookie_redirect_via_refresh on;
    	###testcookie_refresh_template '<html><body>		<script>document.cookie="ToffsCDN=$testcookie_set";location.href="$testcookie_nexturl";</script></body></html>';

	###level 3 (un-test)
	#testcookie_refresh_template '<html><body>setting cookie...<script type=\"text/javascript\" src=\"/aes.min.js\" ......;



        #root html;
        location / {
        
        	ModSecurityEnabled on;
			###ModSecurityConfig modsecurity.conf0;
            ModSecurityConfig /toffs/nginx/conf/_modsec_includes/ngx2_toffstech_com_modsec_includes.conf;

			testcookie on;

            proxy_pass http://toffs;
		
			proxy_redirect     off;
			proxy_set_header   Host             $host;

			proxy_set_header   X-Real-IP        $remote_addr;
        	proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;
        	proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
        	proxy_max_temp_file_size 0;
        	proxy_connect_timeout      90;
        	proxy_send_timeout         90;
        	proxy_read_timeout         90;
        	proxy_buffer_size          4k;
        	proxy_buffers              4 32k;
        	proxy_busy_buffers_size    64k;
        	proxy_temp_file_write_size 64k;
				
        }
    }

}
